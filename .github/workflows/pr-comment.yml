name: Run on Comment
on:
  issue_comment:
    types: 
      - created
      - edited
permissions:
  contents: read
  issues: read
  pull-requests: read
  statuses: write
env:
  GH_TOKEN: ${{ github.token }}
  WORKFLOW_TO_DOWNLOAD_ARTIFACT_FROM: pip-licenses.yml
jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && github.event.comment.body == '/run'
    steps:
      - name: Get PR Branch
        run: |
          pr_url="$(
            jq --raw-output '.issue.pull_request.url' "${GITHUB_EVENT_PATH}"
          )"
            gh api "${pr_url}" --jq '.head | .ref,.sha' |
              read -rd '' PR_HEAD_BRANCH PR_HEAD_SHA
          env_vars="PR_HEAD_BRANCH=${PR_HEAD_BRANCH}\n"
          env_vars+="PR_HEAD_SHA=${PR_HEAD_SHA}\n"
          echo -en "${env_vars}" >>"${GITHUB_ENV}"
      - name: Set Commit Status to Pending
        uses: myrotvorets/set-commit-status-action@master
        with:
          sha: ${{ env.PR_HEAD_SHA }}
          token: ${{ secrets.GITHUB_TOKEN }}
          status: pending
          context: Context
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ env.PR_HEAD_SHA }}
      - name: Download Run ID Artifact
        run: |
          run_id="$(
            gh run list \
              --branch "${{ env.PR_HEAD_BRANCH }}" \
              --workflow "${{ env.WORKFLOW_TO_DOWNLOAD_ARTIFACT_FROM }}" \
              --status success \
              --json databaseId \
              --jq '.[0].databaseId'
          )"
          gh run download "${run_id}" \
            --name "${run_id}-BUILD_DEPENDENCY_LICENSES.md" \
            --dir gh_download
          cat gh_download/BUILD_DEPENDENCY_LICENSES.md
      - name: Set Final Commit Status
        uses: myrotvorets/set-commit-status-action@master
        if: always()
        with:
          sha: ${{ env.PR_HEAD_SHA }}
          token: ${{ secrets.GITHUB_TOKEN }}
          status: ${{ job.status }}
          context: Context