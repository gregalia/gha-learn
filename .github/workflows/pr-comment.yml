name: Run on Comment
on:
  issue_comment:
    types: 
      - created
      - edited
permissions:
  contents: read
  issues: read
  pull-requests: read
env:
  GH_TOKEN: ${{ github.token }}
  WORKFLOW_TO_DOWNLOAD_ARTIFACT_FROM: pip-licenses.yml
jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && github.event.comment.body == '/run'
    steps:
      - name: Get PR Branch
        run: |
          pr_url="$(
            jq --raw-output '.issue.pull_request.url' "${GITHUB_EVENT_PATH}"
          )"
          echo "PR_BRANCH=$(
            gh api "${pr_url}" --jq '.head.ref'
          )" >>"${GITHUB_ENV}"
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ env.PR_BRANCH }}
      - name: Download Run ID Artifact
        run: |
          run_id="$(
            gh run list \
              --branch "${{ env.PR_BRANCH }}" \
              --workflow "${{ env.WORKFLOW_TO_DOWNLOAD_ARTIFACT_FROM }}" \
              --status success \
              --json databaseId \
              --jq '.[0].databaseId'
          )"
          gh run download "${run_id}" \
            --name "${run_id}-BUILD_DEPENDENCY_LICENSES.md" \
            --dir gh_download
          cat gh_download/BUILD_DEPENDENCY_LICENSES.md
